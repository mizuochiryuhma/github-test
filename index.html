<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>都市鉱山AI判定アプリ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>    
    <style>body {background-color: #1d3766; }</style>
  </head>
  <body>
    <h1 style="text-align: center; background-color: #365896; color:#84a8b6; letter-spacing: 8px;"><strong>都市鉱山AI判定アプリ</strong></h1>
    <h2 style="color: #84a8b6;">電子廃材をカメラに映すことで、どれだけの銅が含まれているかをAIが判別します</h2>

    <button onclick="testSpeak()">音声テスト</button>
    <p>
        <button id="btn-start" type="button" onclick="init()" style="width: 100px; height: 64px; color: #ffffff; background-color: forestgreen; border-radius: 16px;">AI起動</button>
        <button id="btn-stop" type="button" onclick="stopAI()" disabled style="width: 100px; height: 64px; color: #ffffff; background-color: rgb(201, 36, 69); border-radius: 16px;">AI終了</button>
    </p>

    <div id="webcam-container"></div>
    <h4 id="label" style="color: #15ff00;">待機中…</h4>

    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <script>
      const URL = "https://teachablemachine.withgoogle.com/models/-B4srkNTo/";
      let model, webcam, maxPredictions;
      let stopFlag = false;

 // ★ここに追加(音声合成の制御）★
        let isRunning = false;
        let rafId = null;
        let lastSpoken = "";
        let lastSpokenAt = 0;
        const SPEAK_COOLDOWN_MS = 2500;

      async function init() {
 　　　 if (isRunning) return;          // 多重起動防止
  　　　isRunning = true;
  　　　stopFlag = false;
  　　　// 画面を初期化（カメラ枠が増えないように）
  　　　const container = document.getElementById("webcam-container");
  　　　container.innerHTML = "";
  　　　// ボタン状態切替
  　　　document.getElementById("btn-start").disabled = true;
  　　　document.getElementById("btn-stop").disabled = false;
  　　　const modelURL = URL + "model.json";
  　　　const metadataURL = URL + "metadata.json";
 　　　 model = await tmImage.load(modelURL, metadataURL);
  　　　webcam = new tmImage.Webcam(200, 200, true);
  　　　await webcam.setup();
  　　　await webcam.play();
  　　　container.appendChild(webcam.canvas);
  　　　maxPredictions = model.getTotalClasses();
  　　　speakOnce("AIを起動しました");
  　　　rafId = window.requestAnimationFrame(loop);
　　　}

     async function loop() {
  if (stopFlag || !webcam) return;
  webcam.update();
  await predict();
  rafId = window.requestAnimationFrame(loop);
　　　}

      async function predict() {
        const prediction = await model.predict(webcam.canvas);
        let highestProb = 0;
        let bestLabel = "";

       

        for (let i = 0; i < prediction.length; i++) {
          if (prediction[i].probability > highestProb) {
            highestProb = prediction[i].probability;
            bestLabel = prediction[i].className;
          }
        }

        const result = document.getElementById("label");
        result.innerText =
          bestLabel + "（" + (highestProb * 100).toFixed(1) + "%）";

        const TH_STRICT = 0.8;
        const TH_UNSURE = 0.5;

        if (highestProb >= TH_STRICT && (bestLabel === "高銅" || bestLabel === "低銅")) {
          if (bestLabel === "高銅") {
            speakOnce("宝のやま～");
          } else {
            speakOnce("やめとき～");
          }

        } else if (highestProb >= TH_UNSURE) {
          speakOnce("ちょっとよくわからない");

        } else {
          speakOnce("判定できません");
        }
      }

      function speakOnce(text) {
        const synth = window.speechSynthesis;
        if (synth && !synth.speaking) {
          const utter = new SpeechSynthesisUtterance(text);
          utter.lang = "ja-JP";
          setTimeout(() => synth.speak(utter), 100);
        }
      }
function speakOnce(text) {
  const now = Date.now();

  // 同じ文言を短時間で繰り返さない
  if (text === lastSpoken && (now - lastSpokenAt) < SPEAK_COOLDOWN_MS) return;

  const synth = window.speechSynthesis;
  if (!synth) return;

  // しゃべっている最中は追加しない
  if (synth.speaking) return;

  lastSpoken = text;
  lastSpokenAt = now;

  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "ja-JP";
  setTimeout(() => synth.speak(utter), 50);
}

      function testSpeak() {
        const synth = window.speechSynthesis;
        if (!synth) {
          alert("Speech Synthesis API 非対応");
          return;
        }
        const utter = new SpeechSynthesisUtterance("こんにちは、テストです。");
        utter.lang = "ja-JP";
        synth.speak(utter);
      }

    async function stopAI() {
  stopFlag = true;
  isRunning = false;

  // ループ停止
  if (rafId) {
    cancelAnimationFrame(rafId);
    rafId = null;
  }

  // 音声停止
  if (window.speechSynthesis) window.speechSynthesis.cancel();

  // カメラ停止
  if (webcam) {
    await webcam.stop();
    webcam = null;
  }

  // 画面掃除
  document.getElementById("webcam-container").innerHTML = "";
  document.getElementById("label").innerText = "待機中…";

  // ボタン状態を戻す
  document.getElementById("btn-start").disabled = false;
  document.getElementById("btn-stop").disabled = true;

  speakOnce("AIを終了します");
}

    </script>
    <div class="how_to_use" style="background-color: #427a96; width: 640px;">
        <h3 style="color: #33dbdb; font-size: 32px; text-align: center;">使用方法</h3>
        <p style="color: #d4fcf8; size: 16px;">1, 「<strong>AI起動</strong>」ボタンを押します（カメラの使用を許可してください）</p>
        <p style="color: #d4fcf8; size: 16px;">2, 起動後、判別したい廃材を用意してそれが真ん中にくるよう映します</p>
        <p style="color: #d4fcf8; size: 16px;">3, AIがデータの統計から含まれている銅の量を推測し、判別してくれます！</p>
    </div>
    <div class="attention" style="background-color: #427a96; width: 640px;">
     <h3 style="color: #db3333; font-size: 32px; text-align: center;">⚠注意⚠</h3>
     <p style="color: #e4ad17;">・AIを使用する環境によって判定結果が変わる恐れがあります。ご使用の際は、<strong>常に同じ環境下</strong>で使用してください。</p>
     <p style="color: #e4ad17;">・他人の顔を意図的に写さないでください。<strong>プライバシー権の侵害</strong>や、<strong>肖像権侵害</strong>に触れてしまう可能性があります。</p>
    </div>
    <div class="members" style="background-color: #427a96; width: 640px; height: 480px;">
        <p style="color: #65f077; font-size: 32px; text-align: center;">
            開発メンバー
        </p>
    <!-- インターネット上に一般公開されているとのことですので、本名を伏字としております。-->
        <p style="color: #d4fcf8; font-size: 24px;">リーダー/電解精錬：XXXX XXX</p>
        <p style="color: #d4fcf8; font-size: 20px;">副リーダー/プログラム：XXX XX</p>
        <p style="color: #d4fcf8;">メンバー/電解精錬：XXX XXX</p>
        <p style="color: #d4fcf8;">メンバー/プログラム：XXX XXX</p>
        <p style="color: #d4fcf8;">メンバー/電解精錬：XXXX XXXXX</p>
        <p style="color: #d4fcf8;">メンバー/電解精錬：XXXX XXX</p>
        <p style="color: #d4fcf8;">メンバー/電解精錬：XXXX XXXX</p>
        <p style="color: #d4fcf8; font-size: 24px;">監督/プログラム：XXXX XXXX</p>
    </div>
    <p style="color: #ffffff; text-align: right; text-decoration: underline;">バージョン 1.0<a href="https://abehiroshi.la.coocan.jp/" target="_blank" style="color: #ffffff;">.</a>0</p>
    <!--（これは支援サービスのサイトに飛ばすだけで支援をもらえるわけでは）ないです。本当にもらいたいならアカウントでも作ってもらって、どうぞ。-->
    <a href="https://buymeacoffee.com/" target="_blank" style="color: #41d633;">よろしければ支援をお願いします！</a>
    
    <style>
@keyframes scroll {
  from { transform: translateX(0); }
  to   { transform: translateX(-100%); }
}
</style>

<div style="overflow:hidden; width:100%; background-color: #365896; height: 48px;">
  <p style="display:inline-block; padding-left:100%; white-space:nowrap; animation: scroll 256s linear infinite; color: #33dbdb; size: 16px;">このWebサイトはVisual Studio Codeを使用して作成されました。銅の判定AIはTeachable Machineを使用して作成されました。このWebサイトの一部はChatGPTを使用して生成されたコードを使用しています。このWebサイトはXXX XXによってデザインされました。このWebサイトのデザインはMicrosoft Edgeで作ったので他のサイトで正しく描画されているかはテストしていません。もし異常があった場合はこちらにご連絡ください"XXXXXXXXXXXX@XXXXX.XXX"(個人情報が含まれるため一部伏字としてあります) このWebサイトはVisual Studio Codeを使用して作成されました。あれ？さっき言ったっけ？ちょっと夜遅くに編集してるせいで記憶がぼんやりしてるな～ このウェブサイトは2年の努力を重ねてようやく完成させました。あはは、嘘です、2時間です。・・・もうちょっと少ないかも。</p>
</div>
  </body>
</html>
